@model StreamViewModel

<div id="settings-wrapper">
    @{
        var modeToggleTitle = Model.IsDarkMode
            ? "Dark Mode"
            : "Light Mode";

        var isChatVisible = Model.ShowChat.ToString().ToLower();
    }

    <ul class="settings-tabs">
        <li><a href="#" id="options-toggle">Update Streams</a></li>
        <li><a href="#" id="chat-toggle">Toggle Chat</a></li>
        <li><a href="#" id="light-dark-toggle">@modeToggleTitle</a></li>
    </ul>
</div>

<div id="options-wrapper">
    <form asp-controller="Stream" asp-action="Index" method="post">
        <input type="hidden" name="Channels" id="parsed-streamlist" value="@ViewData["ParsedList"]" />

        <label class="form-label">Streams</label>
        <ul class="stream-options">
            @foreach (var channel in Model.Channels)
            {
                <li>
                    <input type="checkbox" name="@channel" id="@channel" class="stream-checkbox" checked />
                    <label for="@channel">@channel</label>
                </li>
            }
        </ul>

        <hr />

        <input type="text" id="stream-selector" class="form-field" />
        <input type="button" id="add-stream" class="form-button" value="Add" />
        
        <input asp-for="IsDarkMode" id="theme-checkbox" class="form-checkbox" />
        <label asp-for="IsDarkMode" class="form-checklabel"></label>
        
        <input asp-for="ShowChat" id="chat-checkbox" class="form-checkbox" />
        <label asp-for="ShowChat" class="form-checklabel"></label>

        <div class="form-multibuttons">
            <input type="button" id="cancel-update" class="form-button" value="Cancel" />
            <input type="submit" class="form-button" value="Update" />
        </div>   
    </form>
</div>
<div id="options-overlay"></div>

<div id="stream-wrapper" class="left">
    @foreach (var stream in Model.Channels) {
        var twitchUrl = $"https://player.twitch.tv/?channel={stream}&muted=true&parent={ViewData["DomainUrl"]}&parent=www.{ViewData["DomainUrl"]}";
        <iframe id="embed-@stream"
                class="stream"
                src="@twitchUrl"
                allowfullscreen>
        </iframe>
    }
</div>

<div id="chat-wrapper" class="right">
    <partial name="_StreamChat" model="new StreamChatViewModel(Model.Channels, Model.IsDarkMode)" />
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            if (!@Model.IsDarkMode.ToString().ToLower()) { togglePageTheme('light'); }

            optimiseStreamEmbeds(@Model.Channels.Count, @Model.ShowChat.ToString().ToLower());
            $('#options-wrapper').moveToAbsoluteCenter();

            setSelectedChatTab();

            $('#chat-wrapper').on('click', '.chat-tabs a', function (e) {
                let selectedAttrValue = $(this).attr('href');

                $(selectedAttrValue).show().siblings().hide();

                $(this).parent('li').addClass('active').siblings().removeClass('active');

                e.preventDefault();
            });

            $('#options-toggle').on('click', function (e) {
                e.preventDefault();
                toggleOptionsPanel();
            });

            $('#chat-toggle').on('click', function (e) {
                e.preventDefault();

                let showChatWindow = toggleChatWindow();
                optimiseStreamEmbeds(-1, showChatWindow);

                if ($('#options-wrapper').css('display') === 'none') { $('#chat-checkbox').prop('checked', $('#chat-wrapper').css('display') === 'block'); }
            });

            $('#light-dark-toggle').on('click', function (e) {
                e.preventDefault();

                if ($(this).text() === 'Dark Mode') {
                    togglePageTheme('light');
                    $(this).text('Light Mode');
                }
                else {
                    togglePageTheme('dark');
                    $(this).text('Dark Mode');
                }

                let selectedAttrValue = $('#chat-wrapper .chat-tabs li.active a').attr('href');
                let isDark = $(this).text() === 'Dark Mode';

                let request = $.ajax({
                    method: 'POST',
                    url: '@Url.Action("Chat", "Stream")',
                    data: {
                        Channels: '@ViewData["ParsedList"]'.split(',').filter(element => element),
                        IsDarkMode: isDark
                    }
                });

                request.done(function (html) {
                    $('#chat-wrapper').html(html);

                    optimiseStreamEmbeds(@Model.Channels.Count, $('#chat-wrapper').css('display') === 'block');
                    setSelectedChatTab(selectedAttrValue);

                    if ($('#options-wrapper').css('display') === 'none') { $('#theme-checkbox').prop('checked', isDark); }
                });
            });

            $('#options-wrapper .stream-options').on('change', '.stream-checkbox', updateParsedList);

            $('#add-stream').on('click', function (e) {
                e.preventDefault();
                let val = $('#stream-selector').val().trim();
                console.log(val);

                if (val.includes(',')) {
                    console.log('Comma list detected');
                    let arr = val.split(',').filter(element => element);

                    for (let i = 0; i < arr.length; i++) {
                        addStreamToList(arr[i]);
                    }
                }
                else {
                    addStreamToList(val);
                }

                $('#stream-selector').val('');

                updateParsedList();
            });

            $('#cancel-update').on('click', function (e) {
                e.preventDefault();
                toggleOptionsPanel();

                $('.stream-options li').remove();

                let originalVals = '@ViewData["ParsedList"]'.split(',').filter(element => element);

                for (let i = 0; i < originalVals.length; i++) {
                    addStreamToList(originalVals[i]);
                }

                $('#theme-checkbox').prop('checked', $('#light-dark-toggle').text() === 'Dark Mode');
                $('#chat-checkbox').prop('checked', $('#chat-wrapper').css('display') === 'block');

                $('#options-wrapper').moveToAbsoluteCenter();
            });

            $(window).resize(function () {
                optimiseStreamEmbeds(-1, $('#chat-wrapper').css('display') === 'block');
                $('#options-wrapper').moveToAbsoluteCenter();
            });
        });

        function setSelectedChatTab(selected) {
            if (selected) {
                $(selected).addClass('active');
                $('.chat-tabs li a[href="' + selected + '"]').parent('li').addClass('active');
            }
            else {
                $(".chat-tab-content div").first().addClass('active');
                $(".chat-tabs li").first().addClass('active');
            }
        }

        function addStreamToList(stream) {
            let element = '<input type="checkbox" name="' + stream + '" id="' + stream + '" class="stream-checkbox" checked />';
            element += '<label for="' + stream + '">' + stream + '</label>';

            $('.stream-options').append($('<li>').html(element));
        }

        function updateParsedList() {
            let value = '';

            $('.stream-checkbox').each(function () {
                if ($(this).prop('checked')) {
                    value += $(this).prop('name') + ',';
                }
            });

            $('#parsed-streamlist').val(value);
            $('#options-wrapper').moveToAbsoluteCenter();
        }
    </script>
}